<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>交易记录表格</title>

    <!-- 依赖引入 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css">
    <script src="https://unpkg.com/element-plus"></script>
    <script src="https://unpkg.com/@element-plus/icons-vue"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>

    <style>
        .app-container {
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .filter-group {
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
        }

        .amount-income {
            color: #67c23a;
            font-weight: 500;
        }

        .amount-expense {
            color: #f56c6c;
            font-weight: 500;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .custom-tag {
            border-radius: 12px;
            padding: 0 10px;
        }

        .positive {
            color: #67c23a;
            /* Element Plus 成功绿色 */
        }

        .negative {
            color: #f56c6c;
            /* Element Plus 警示红色 */
        }
    </style>
</head>

<body>
    <div id="app">
        <div class="app-container">
            <!-- 过滤条件 -->
            <div class="filter-group">
                <el-input v-model="filter.symbol" placeholder="搜索交易品种" clearable style="width: 220px">
                    <template #prefix>
                        <el-icon>
                            <Search />
                        </el-icon>
                    </template>
                </el-input>

                <el-select v-model="filter.openSide" placeholder="交易类型" clearable style="width: 150px">
                    <el-option v-for="item in typeOptions" :key="item.value" :label="item.label" :value="item.value" />
                </el-select>

                <!-- 数值范围筛选 -->

                <el-input v-model="filter.amountMin" style="width: 200px" type="number"
                    placeholder="最大持仓min"></el-input>
                <span class="separator">-</span>
                <el-input v-model="filter.amountMax" style="width: 200px" type="number"
                    placeholder="最大持仓max"></el-input>


                <el-date-picker v-model="filter.dateMin" type="date" placeholder="开始日期" value-format="X"
                    :default-time="defaultTime"></el-date-picker>
                <span class="separator">至</span>
                <el-date-picker v-model="filter.dateMax" type="date" placeholder="结束日期" value-format="X"
                    :default-time="defaultTime"></el-date-picker>

                <el-button type="primary" @click="handleSearch">
                    查询
                </el-button>
            </div>


            <!-- 统计 -->

            <el-descriptions style="margin-bottom: 20px;" :column="5" :size="size" border>
                <el-descriptions-item label="净盈亏">
                    {{ Number(statisticsData.totalPnlWithCommission).toFixed(2) }}
                </el-descriptions-item>
                <el-descriptions-item label="总盈利(不含手续费)">
                    {{ Number(statisticsData.totalWinPnl).toFixed(2) }}
                </el-descriptions-item>
                <el-descriptions-item label="总亏损(不含手续费)">
                    {{ Number(statisticsData.totalLossPnl).toFixed(2) }}
                </el-descriptions-item>
                <el-descriptions-item label="手续费">
                    {{ Number(statisticsData.totalCommission).toFixed(2) }}
                </el-descriptions-item>
                <el-descriptions-item label="资金费">
                    {{ 0 }}
                </el-descriptions-item>
                <el-descriptions-item label="平均最大持仓">
                    {{ Number(statisticsData.avgMaxCumQuote).toFixed(2) }}
                </el-descriptions-item>
                <el-descriptions-item label="胜率">
                    {{ (statisticsData.winTimes / (statisticsData.winTimes + statisticsData.lossTimes) * 100).toFixed(2)
                    }}%
                </el-descriptions-item>
                <el-descriptions-item label="盈亏比">
                    {{ (statisticsData.avgWinWithCommission / statisticsData.avgLossWithCommission * -1 ).toFixed(2) }}
                </el-descriptions-item>
                <el-descriptions-item label="期望值">
                    {{ getExpect(statisticsData).toFixed(2) }}
                </el-descriptions-item>
                <el-descriptions-item label="平均持仓时间">
                    {{ formatTakeTime(statisticsData.avgTakeTime/1000) }}
                </el-descriptions-item>
            </el-descriptions>

            <!-- 交易数据表格 -->
            <el-table :data="tableData" style="width: 100%" border stripe v-loading="loading"
                @sort-change="handleSortChange">

                <el-table-column prop="startTime" label="日期" width="120" sortable>
                    <template #default="{ row }">
                        {{ new Date(row.startTime).toISOString().split('T')[0] }}
                    </template>
                </el-table-column>

                <el-table-column prop="type" label="交易品种" width="120" sortable>
                    <template #default="{ row }">
                        {{ row.symbol }}
                    </template>
                </el-table-column>

                <el-table-column prop="side" label="类型" width="120" sortable>
                    <template #default="{ row }">
                        <span :class="row.side == 'SELL' ? 'negative': 'positive'">
                            {{ row.side }}
                        </span>
                   
                    </template>
                </el-table-column>


                <el-table-column prop="openPrice" label="开仓价格" width="120">
                    <template #default="{ row }">
                        {{ row.openPrice }}
                    </template>
                </el-table-column>


                <el-table-column prop="closePrice" label="平仓价格" width="120">
                    <template #default="{ row }">
                        {{ row.closePrice }}
                    </template>
                </el-table-column>

                <el-table-column prop="firstOpenCumQuote" label="开仓" width="120" sortable>
                    <template #default="{ row }">
                        {{ row.firstOpenCumQuote.toFixed(0) }}
                    </template>
                </el-table-column>

                <el-table-column prop="maxCumQuote" label="最大持仓" width="120" sortable>
                    <template #default="{ row }">
                        {{ row.maxCumQuote.toFixed(0) }}
                    </template>
                </el-table-column>

                <el-table-column prop="type" label="持仓时间" width="120">
                    <template #default="{ row }">
                        {{ formatTakeTime((row.endTime - row.startTime)/1000) }}
                    </template>
                </el-table-column>


                <el-table-column prop="commission" label="手续费" width="120" sortable>
                    <template #default="{ row }">
                        {{ row.commission.toFixed(2) }}
                    </template>
                </el-table-column>

                <el-table-column prop="pnl" label="盈亏" width="120" sortable>
                    <template #default="{ row }">
                        <span :class="getProfitClass(row.pnl)">
                            {{ row.pnl.toFixed(1) }}
                        </span>
                    </template>
                </el-table-column>

                <el-table-column prop="type" label="幅度" width="120">
                    <template #default="{ row }">
                        <span :class="getProfitClass(row.pnl)">
                            {{getDiffPercent(row) }} %
                        </span>
                    </template>
                </el-table-column>


                <!-- <el-table-column prop="type" label="复盘" width="120">
                    <template #default="{ row }">
                        {{ row.comment }}
                    </template>
                </el-table-column> -->
            </el-table>

            <!-- 分页 -->
            <div style="margin-top: 20px; display: flex; justify-content: flex-end;">
                <el-pagination v-model:current-page="pagination.current" v-model:page-size="pagination.size"
                    :page-sizes="[10, 20, 50, 100]" :total="pagination.total" layout="total, sizes, prev, pager, next"
                    background @current-change="loadData" @size-change="handleSizeChange" />
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref } = Vue;
        const { ElTable, ElTableColumn, ElPagination, ElInput, ElSelect, ElOption, ElButton, ElTag, ElIcon } = ElementPlus;
        const { Search, Money, Top, Bottom, Refresh, List, User, Warning } = ElementPlusIconsVue;

        const host = "/api"

        createApp({
            components: {
                ElTable, ElTableColumn, ElPagination, ElInput,
                ElSelect, ElOption, ElButton, ElTag, ElIcon,
                Search, Money, Top, Bottom, Refresh
            },
            setup() {
                const tableData = ref([]);
                const loading = ref(false);
                const error = ref('');
                const searchKey = ref('');

                const filter = ref({
                    symbol: '',
                    type: '',
                    amountMin: '',
                    amountMax: '',
                    dateMin: 0,
                    dateMax: 0
                });

                const pagination = ref({
                    current: 1,
                    size: 10,
                    total: 0
                });

                const sortParams = ref({
                    sortBy: '',
                    sortOrder: ''
                });

                // 配置项
                const typeOptions = [
                    { value: 'BUY', label: 'BUY' },
                    { value: 'SELL', label: 'SELL' },
                ];



                const statusTypes = {
                    success: 'success',
                    failed: 'danger',
                    processing: 'warning'
                };

                // 金额格式化
                const formatCurrency = (value) => {
                    return Number(value).toLocaleString('zh-CN', {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2
                    });
                };

                // 加载数据
                const loadData = async () => {

                    loading.value = true;
                    try {
                        // const params = {
                        //     page: pagination.value.current,
                        //     pageSize: pagination.value.size,
                        //     ...filter.value,
                        //     ...sortParams.value
                        // };

                        await fetchData();
                        await fetchStatistics();
                    } finally {
                        loading.value = false;
                    }
                };

                // 分页大小变化
                const handleSizeChange = (size) => {
                    pagination.value.size = size;
                    pagination.value.current = 1;
                    loadData();
                };

                // 排序变化
                const handleSortChange = ({ prop, order }) => {
                    sortParams.value = {
                        sortBy: prop,
                        sortOrder: order === 'ascending' ? 'asc' : 'desc'
                    };
                    loadData();
                };

                // 执行查询
                const handleSearch = () => {
                    pagination.value.current = 1;
                    loadData();
                };


                const fetchData = async () => {
                    loading.value = true;
                    error.value = '';
                    try {
                        const params = {
                            page: pagination.value.current,
                            pageSize: pagination.value.size,

                            ...filter.value,
                            ...sortParams.value
                        };

                        const urlParams = new URLSearchParams(window.location.search);
                        const token = urlParams.get('token')

                        // 真实API请求
                        const response = await axios.get(`${host}/getCombineOrderList`, {
                            params,
                            timeout: 10000,
                            headers: { 'token': token }
                        },);

                        // 处理响应数据（根据实际API结构调整）

                        if (response.data.data) {
                            // console.log(response.data)
                            tableData.value = response.data.data;
                            pagination.value.total = response.data.count;
                        } else {
                            error.value = response.data.message || '接口返回错误';
                        }
                    } catch (err) {
                        handleRequestError(err);
                    } finally {
                        loading.value = false;
                    }
                };


                const statisticsData = ref({
                    // avgFirstOpenCumQuote: 0,
                    // avgLoss: 0,
                    // avgLossWithCommission: 0,
                    // avgMaxCumQuote: 0,
                    // avgTakeTime: 0,
                    // avgWin: 0,
                    // avgWinWithCommission: 0,
                    // lossTimes: 0,
                    // totalCommission: 0,
                    // totalPnl: '',
                    // totalPnlWithCommission: 0,
                    // winTimes: 0,
                });
                const fetchStatistics = async () => {
                    // loading.value = true;
                    error.value = '';
                    try {
                        const params = {
                            ...filter.value,
                        };

                        const urlParams = new URLSearchParams(window.location.search);
                        const token = urlParams.get('token')

                        // 真实API请求
                        const response = await axios.get(`${host}/getCombineOrderStatis`, {
                            params,
                            timeout: 10000,
                            headers: { 'token': token }
                        },);

                        // 处理响应数据（根据实际API结构调整）

                        if (response.data.data) {
                            statisticsData.value = response.data.data
                            // Object.assign(statisticsData, response.data.data); // 将接口数据合并到响应式对象
                            console.log(statisticsData)
                        } else {
                            error.value = response.data.message || '接口返回错误';
                        }
                    } catch (err) {
                        handleRequestError(err);
                    } finally {
                        // loading.value = false;
                    }
                };

                // 错误处理
                const handleRequestError = (err) => {
                    console.log(err)
                    if (err.response) {
                        // HTTP状态码错误
                        error.value = `请求错误：${err.response.status} ${err.response.data?.message || ''}`;
                    } else if (err.request) {
                        // 请求未收到响应
                        error.value = '网络连接异常，请检查网络';
                    } else {
                        // 其他错误
                        error.value = `请求失败：${err.message}`;
                    }
                };

                // 计算盈亏幅度
                const getDiffPercent = (transaction) => {
                    let diff = transaction.closePrice - transaction.openPrice
                    if (diff < 0) {
                        diff = -diff
                    }
                    let percent = (diff / transaction.openPrice) * 100
                    percent = percent.toFixed(1);
                    if (transaction.pnl > 0) {
                        return percent
                    } else {
                        return -percent
                    }
                }

                // 计算持仓时间
                const formatTakeTime = (diffsecond) => {
                    let second = diffsecond
                    if (second < 60) {
                        return Math.round(second) + "秒"
                    }
                    let min = second / 60
                    if (min < 60) {
                        return Math.round(min) + "分钟"
                    }
                    let h = min / 60
                    return Math.round(h) + "小时"
                }

                const getProfitClass = (profit) => {
                    return profit > 0 ? 'positive' : 'negative';
                };

                const getExpect = (row) => {
                    let winRate =  row.winTimes / (row.winTimes + row.lossTimes)
                    let ykb = row.avgWinWithCommission / row.avgLossWithCommission * -1
                    
                    return winRate * ykb - (1-winRate) 
                }

                // 初始化加载
                loadData();

                return {
                    tableData,
                    filter,
                    pagination,
                    loading,
                    typeOptions,
                    statisticsData,
                    loadData,
                    formatCurrency,
                    handleSizeChange,
                    handleSortChange,
                    handleSearch,

                    getDiffPercent,
                    formatTakeTime,
                    getProfitClass,
                    getExpect
                };
            }
        }).use(ElementPlus).mount('#app');
    </script>
</body>

</html>